<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Return</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
  }
  #app {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-top: 20px;
  }
  #delivery-form {
    margin-bottom: 20px;
  }
  #delivery-table {
    width: 80%;
    border-collapse: collapse;
    margin-top: 20px;
  }
  #delivery-table th, #delivery-table td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
  }
</style>
</head>
<script src="/socket.io/socket.io.js"></script>
<script>
  var socket = io();
</script>
<body>
<div id="app">
  <h1>Return</h1>
  <form id="return-form">
    <label for="do-no">DO No.:</label>
    <input type="text" id="do-no" required>
    <label for="transporter">Transporter:</label>
    <select id="transporter" required>
      <option value="Local 01">Local 01</option>
      <option value="Local 02">Local 02</option>
      <option value="Local 03">Local 03</option>
      <option value="Local 04">Local 04</option>
      <option value="Freight Mark">Freight Mark</option>
      <option value="City-Link">City-Link</option>
      <option value="Tiong Nam">Tiong Nam</option>
      <option value="Pos Laju">Pos Laju</option>
      <option value="Other">Other</option>
    </select>
    <label for="reason">Reason:</label>
    <input type="text" id="reason" required>
    <label for="date">Date:</label>
    <input type="date" id="date" class="date-input" required>
    <button type="submit">Update</button>
  </form>
  <h2>Return History</h2>
  <table id="return-table">
    <thead>
      <tr>
        <th>DO No.</th>
        <th>Transporter</th>
        <th>Reason</th>
        <th>Date</th>
        <th>Status</th>
        <th>Follow-up</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="return-history"></tbody>
  </table>
</div>
<script>
    const returnForm = document.getElementById("return-form");
    const returnHistory = document.getElementById("return-history");
    let returns = JSON.parse(localStorage.getItem("returns")) || [];

    function formatDate(dateString) {
      const options = { year: "numeric", month: "short", day: "numeric" };
      return new Date(dateString).toLocaleDateString(undefined, options);
    }
  
    function addReturnToLocalStorage(returnData) {
      const returns = JSON.parse(localStorage.getItem("returns")) || [];
      returns.push(returnData);
      localStorage.setItem("returns", JSON.stringify(returns));
    }

    function saveReturnsToLocalStorage(returns) {
      localStorage.setItem("returns", JSON.stringify(returns));
    }
  
    function addRowToTable(returnData, index) {
      const row = returnHistory.insertRow();
      const doNoCell = row.insertCell();
      const transporterCell = row.insertCell();
      const reasonCell = row.insertCell();
      const dateCell = row.insertCell();
      const statusCell = row.insertCell();
      const followUpCell = row.insertCell();
      const actionsCell = row.insertCell();

      doNoCell.textContent = returnData.doNo;
      transporterCell.textContent = returnData.transporter;
      reasonCell.textContent = returnData.reason;
      dateCell.textContent = formatDate(returnData.date);

      const statusSelect = document.createElement("select");
      const statusOptions = ["", "Follow-up", "Completed"];
      statusOptions.forEach(option => {
        const statusOption = document.createElement("option");
        statusOption.value = option;
        statusOption.text = option || "-";
        statusSelect.appendChild(statusOption);
      });

      statusSelect.value = returnData.status;
      statusCell.appendChild(statusSelect);

      const followUpInput = document.createElement("input");
      followUpInput.type = "text";
      followUpCell.appendChild(followUpInput);

      if (returnData.status === "Completed") {
        followUpInput.value = "Case Closed";
      } else if (returnData.status === "") {
        followUpInput.value = "";
        followUpInput.disabled = true;
      } else {
        followUpInput.value = returnData.followUp || "";
      }

      followUpInput.addEventListener("input", function() {
        returnData.followUp = followUpInput.value; // Update the followUp value
        saveReturnsToLocalStorage();
      });

      function handleStatusChange() {
        returnData.status = statusSelect.value;
        saveReturnsToLocalStorage();

        if (statusSelect.value === "Completed") {
          followUpInput.value = "Case Closed";
          followUpInput.disabled = true;
        } else if (statusSelect.value === "Follow-up") {
          followUpInput.value = returnData.followUp || "";
          followUpInput.disabled = false;
        } else {
          followUpInput.value = "";
          followUpInput.disabled = true;
        }
      }

      statusSelect.addEventListener("change", handleStatusChange);

       if (returnData.status === "Completed" || returnData.status === "") {
        followUpInput.disabled = true;
      } else {
        followUpInput.disabled = false;
      }

      const deleteButton = document.createElement("button");
      deleteButton.textContent = "Delete";
      deleteButton.addEventListener("click", () => {
        deleteReturn(index);
      });
      actionsCell.appendChild(deleteButton);
    }

      // Connect to the Socket.io server
    //const socket = io(); // Assumes the server is hosted on the same domain and port

    // Event listener for receiving data from the server
    socket.on("returnData", function(returnData) {
      updateTableAfterSubmission(returnData);
    });

    // Event listener for receiving delete event from the server
    socket.on("deleteReturn", function(index) {
      deleteReturn(index);
    });

    // Function to emit new return data to the server
    function emitReturnData(returnData) {
      socket.emit("newReturn", returnData);
    }

    // Function to emit delete event to the server
    function emitDeleteReturn(index) {
      socket.emit("deleteReturn", index);
    }

    
  function loadReturnsFromLocalStorage() {
    returns.forEach((returnData, index) => {
      addRowToTable(returnData, index);
    });
  }

  function updateTableAfterSubmission(returnData) {
    const index = returnHistory.rows.length;
    addRowToTable(returnData, index);
  }

  function deleteReturn(index) {
    returns.splice(index, 1);
    saveReturnsToLocalStorage();

    returnHistory.innerHTML = "";
    loadReturnsFromLocalStorage();

    emitDeleteReturn(index);
  }

  function saveReturnsToLocalStorage() {
    localStorage.setItem("returns", JSON.stringify(returns));
  }
  
    returnForm.addEventListener("submit", function(event) {
      event.preventDefault();

      const doNoInput = document.getElementById("do-no");
      const transporterInput = document.getElementById("transporter");
      const reasonInput = document.getElementById("reason");
      const dateInput = document.getElementById("date");

      const doNo = doNoInput.value;
      const transporter = transporterInput.value;
      const reason = reasonInput.value;
      const date = dateInput.value;
      
      if (doNo) {
        const row = returnHistory.insertRow();
        const doNoCell = row.insertCell();
        const transporterCell = row.insertCell();
        const reasonCell = row.insertCell();
        const dateCell = row.insertCell();
        const statusCell = row.insertCell();
        const actionsCell = row.insertCell();

        doNoCell.textContent = doNo;
        transporterCell.textContent = transporter;
        reasonCell.textContent = reason;
        dateCell.textContent = formatDate(date);
        statusCell.textContent = status;

        const returnData = {
          doNo,
          transporter,
          reason,
          date,
          status,
          followUp: ''
        };
        emitReturnData(returnData);
        addReturnToLocalStorage(returnData);

      }
      location.reload();
    });

    // Load existing data from Local Storage on page load
    loadReturnsFromLocalStorage();
</script>
<head>
    <!-- ... (other meta tags and title) ... -->
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f5f5f5;
      }
      #app {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-top: 20px;
      }
      #return-form {
        background-color: #ffffff;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        width: 80%;
        max-width: 400px; /* Adjust the maximum width as needed */
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      #return-form label {
        width: 100%;
      }
      #return-form button[type="submit"] {
        margin-top: 10px;
      }
      #return-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      #return-table th, #return-table td {
        border: 1px solid #000000;
        padding: 10px;
        text-align: left;
      }
      #return-table th {
        background-color: #78b9fd;
      }
      h1, h2 {
        color: #333333;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      select, input[type="text"], input[type="datetime-local"] {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        margin-bottom: 10px;
        font-size: 14px;
        background-color: #f9f9f9; /* Adjust the background color */
        color: #333; /* Adjust the text color */
        box-sizing: border-box;
      }
      button[type="submit"] {
        background-color: #007bff;
        color: #ffffff;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
      }
      ul {
        list-style: none;
        padding: 0;
      }
      li {
        margin-bottom: 5px;
      }
      #delay-reason-container {
        display: none;
      }
      .date-input {
        padding: 10px;
        font-size: 16px;
        border-radius: 5px;
      }
      .follow-up {
        background-color: yellow;
        color: black;
        padding: 4px 8px;
        border-radius: 4px;
      }

      .completed {
        background-color: green;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
      }

      #return-table select {
        width: 150px; 
        padding: 10px;
        font-size: 16px;
      }
    </style>
  </head>  
  
</body>
</html>
